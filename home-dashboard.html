<head>
	<title></title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
	<script>
		function redisplayDiffTimes() {
			$('span[data-time]').each(function (index, value) {
				this.innerText = formatDate(parseInt(value.getAttribute('data-time')));
			});
		}
		$(function () {
			window.setInterval(redisplayDiffTimes, 10000);
		});
	</script>
</head>

<body>
	{{> body}}
</body>

<template name="body">
	<header style="background-image: url({{background}})">
		<h1>{{settings.title}} {{roomName}}</h1>
		<div class="login-tools">
			{{loginButtons}}
		</div>
		{{#if currentUser}}
			{{#with karma}}
				<span class="karma">You have {{ points }} heart point(s).</span>
			{{/with}}
		{{/if}}
		<div class="clearfix"></div>
	</header>
	{{#if messages_ready}}
	<section id="send-message">
		{{> send-message}}
	</section>
		{{> messages}}
{{else}}
	{{#if loggingIn}}
		{{#if currentUser}}
			Logging in...
		{{else}}
			Please stand by and await further instructions.
		{{/if}}
	{{else}}
		{{#if currentUser}}
			<div class="loading">Loading messages...</div>
		{{else}}
			You are not logged in.
		{{/if}}
	{{/if}}
{{/if}}
	<section id="footer">
		<img src="/fortress.png" width="64px">
	</section>
</template>

<template name="weather-report">
<div class="top-login-block">
{{#with weather}}
	{{weather.weather}} / {{feelslike_string}}
{{/with}}
<br/>
</div>
</template>

<template name="currentUserImage">
{{#if currentUser}}
	<div class="author" style="background-image:url({{imageUrl}})"></div>
{{/if}}
</template>

<template name="messages">
{{#if messages}}
	<section id="messages">
		{{#if newerMessagesExist}}
		<nav class="paging">
			<button onclick="javascript:showNewerMessages()">Show newer messages</button>
		</nav>
		{{/if}}
		{{#each messages}}
			{{> message}}
		{{/each}}
		{{#if olderMessagesExist}}
		<nav class="paging">
			<button onclick="javascript:showOlderMessages()">Show older messages</button>
		</nav>
		{{/if}}
	</section>
{{else}}
	No messages.
{{/if}}
</template>

<template name="send-message">
{{#if currentUser}}
	<form onsubmit="event.preventDefault();">
		<input type="text" style="width:50%" name="new-message"></input>
		<button name="send">Send</button>
	</form>
{{/if}}
</template>

<template name="memificator">
<div class="meme-container" style="background-image: url({{imageUrl}})">
	<div class="inner">
		<div class="top">
			<span contenteditable data-msg-id="{{_id}}" id="meme-{{_id}}-title" class="title meme-text">{{{memeTitle}}}</span><br/>
		</div>
		<div class="bottom">
			<span contenteditable data-msg-id="{{_id}}" id="meme-{{_id}}-subtitle" class="subtitle meme-text">{{{memeSubtitle}}}</span>
		</div>
	</div>
</div>
</template>

<template name="memeDisplay">
<div class="meme-container"
	style="background-image: url({{imageUrl}})">
	<div class="inner">
		<div class="top">
			<span class="title meme-text">{{{memeTitle}}}</span><br/>
		</div>
		<div class="bottom">
			<span class="subtitle meme-text">{{{memeSubtitle}}}</span>
		</div>
	</div>
</div>
</template>

<template name="message">
<div class="message">
	<header>
		{{#withAuthor authorId}}
		<div class="author" title="{{name}}" style="background-image:url({{image}})"></div>
		<span class="name">{{name}}</span>
		{{/withAuthor}}
		<nav>
			{{#ifOwner this}}
				{{#if imageUrl}}
					{{#if meme}}
					{{else}}
					<button class="meme-btn">
						<i class="icon-text-width"></i>
					</button>
					{{/if}}
				{{/if}}
			{{else}}
				{{#ifNotLoved this}}
					<button class="love-btn"><i class="icon-heart"></i></button>
				{{/ifNotLoved}}
			{{/ifOwner}}
		</nav>
	</header>
	{{#if meme}}
		{{#ifOwner this}}
			{{> memificator}}
		{{else}}
			{{> memeDisplay}}
		{{/ifOwner}}
	{{else}}
		{{#if msg}}
			<p>{{say msg}}<p>
		{{/if}}
		{{#if imageUrl}}
			<img src="{{imageUrl}}" />
		{{/if}}
		{{#if youtube}}
			<iframe id="ytplayer" type="text/html" width="400" height="244" src="http://www.youtube.com/embed/?q={{youtube}}&autoplay=0&origin=http://example.com" frameborder="0"></iframe>
		{{/if}}
	{{/if}}
	<div>
		{{#loveLoop this}}
			<i class="icon-heart"></i>
		{{/loveLoop}}
	</div>
	{{#each comments}}
	<div class="comment">
		<div class="author" style="background-image: url({{ getAuthorImage authorId }})"></div>
		<div class="name">{{getAuthorName authorId}}</div>
		<div class="text">{{text}}</div>
	</div>
	{{/each}}
	<nav class="comment">
		{{> currentUserImage }}
		<button class="comment-btn"><i class="icon-comment-alt"></i></button>
		<input type="text" name="text">
	</nav>
</div>
</template>
